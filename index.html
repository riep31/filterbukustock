<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pencarian Data Stok - Google Sheets Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .config-section {
            padding: 30px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid #e0e0e0;
        }

        .config-section.hidden {
            display: none;
        }

        .search-section {
            padding: 30px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid #e0e0e0;
        }

        .search-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-search {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-search:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }

        .btn-clear {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-clear:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-connect {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-connect:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-connected {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
        }

        .status-disconnected {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .results-section {
            padding: 30px;
        }

        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
        }

        .results-count {
            font-weight: 600;
            color: #2c3e50;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        .virtual-table-container {
            height: 600px;
            overflow: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: white;
            position: relative;
        }

        .virtual-table {
            position: relative;
        }

        .table-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr 1fr 1fr 1fr;
            gap: 1px;
        }

        .header-cell {
            color: white;
            padding: 20px 15px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        .table-body {
            position: relative;
        }

        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr 1fr 1fr 1fr;
            gap: 1px;
            background: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        .table-row:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .table-row:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .table-cell {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }

        .number-cell {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .date-cell {
            font-family: 'Courier New', monospace;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
            font-size: 18px;
        }

        .no-data-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #3498db;
            font-size: 18px;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .config-help {
            background: rgba(52, 152, 219, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-help h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .config-help ol {
            margin-left: 20px;
            line-height: 1.6;
        }

        .config-help code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .scroll-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            height: 200px;
        }

        .scroll-thumb {
            width: 100%;
            background: #3498db;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .search-controls {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                justify-content: center;
            }
            
            .results-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .virtual-table-container {
                height: 500px;
            }
            
            .table-header,
            .table-row {
                grid-template-columns: repeat(9, minmax(120px, 1fr));
                font-size: 14px;
            }
            
            .header-cell,
            .table-cell {
                padding: 10px 8px;
            }
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
        }

        .info-message {
            background: rgba(52, 152, 219, 0.1);
            color: #2980b9;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
    </style>
</head>
<body>
    <!-- GitHub Link -->
    <a href="#" class="github-link" id="githubLink" target="_blank" style="display: none;">
        📁 View on GitHub
    </a>

    <div class="container">
        <div class="header">
            <h1>📊 Sistem Pencarian Data Stok</h1>
            <p>Terhubung langsung dengan Google Sheets</p>
        </div>
        
        <!-- Configuration Section -->
        <div class="config-section" id="configSection">
            <div class="config-help">
                <h3>🔧 Setup Google Sheets Integration</h3>
                <ol>
                    <li>Buka Google Sheets Anda</li>
                    <li>Klik <strong>File > Share > Publish to web</strong></li>
                    <li>Pilih <strong>Entire Document</strong> dan format <strong>CSV</strong></li>
                    <li>Klik <strong>Publish</strong> dan copy link yang diberikan</li>
                    <li>Paste link tersebut di field <strong>Google Sheets CSV URL</strong> di bawah ini</li>
                </ol>
            </div>
            
            <div class="form-group">
                <label for="sheetsUrl">🔗 Google Sheets CSV URL</label>
                <input 
                    type="url" 
                    id="sheetsUrl" 
                    placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv&gid=0"
                    value="">
            </div>
            
            <div class="buttons">
                <button class="btn btn-connect" onclick="connectToSheets()">🔗 Hubungkan ke Google Sheets</button>
                <div id="connectionStatus" class="status-indicator status-disconnected">
                    <span>●</span> Belum Terhubung
                </div>
            </div>
            
            <div id="messageContainer"></div>
        </div>
        
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-controls">
                <div class="form-group">
                    <label for="searchItem">🔍 Cari Deskripsi Item</label>
                    <input type="text" id="searchItem" placeholder="Masukkan nama item...">
                </div>
                <div class="form-group">
                    <label for="dateFrom">📅 Tanggal Dari</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="form-group">
                    <label for="dateTo">📅 Tanggal Sampai</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="form-group">
                    <label for="pageSize">📄 Items per Halaman</label>
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-search" onclick="searchData()" id="searchBtn" disabled>🔍 Cari Data</button>
                <button class="btn btn-clear" onclick="clearFilters()" id="clearBtn" disabled>🗑️ Reset Filter</button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section">
            <div class="results-info">
                <div class="results-count" id="resultsCount">Hubungkan ke Google Sheets terlebih dahulu</div>
                <div class="pagination-controls">
                    <button class="btn" onclick="previousPage()" id="prevBtn" disabled>⬅️ Prev</button>
                    <span class="pagination-info" id="paginationInfo">-</span>
                    <button class="btn" onclick="nextPage()" id="nextBtn" disabled>Next ➡️</button>
                </div>
            </div>
            
            <div class="virtual-table-container" id="tableContainer">
                <div class="virtual-table">
                    <div class="table-header">
                        <div class="header-cell">Deskripsi Item</div>
                        <div class="header-cell">Tanggal</div>
                        <div class="header-cell">No. Sumber</div>
                        <div class="header-cell">Tipe</div>
                        <div class="header-cell">Kode Prod</div>
                        <div class="header-cell">Keterangan</div>
                        <div class="header-cell">Kts Masuk</div>
                        <div class="header-cell">Kts Keluar</div>
                        <div class="header-cell">Saldo Akhir</div>
                    </div>
                    <div class="table-body" id="tableBody">
                        <div class="no-data">
                            <div class="no-data-icon">🔗</div>
                            <div>Hubungkan ke Google Sheets untuk melihat data</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 0;
        let isConnected = false;
        let sheetsUrl = '';

        // Configuration
        function connectToSheets() {
            const url = document.getElementById('sheetsUrl').value.trim();
            if (!url) {
                showMessage('Silakan masukkan URL Google Sheets!', 'error');
                return;
            }

            if (!url.includes('docs.google.com/spreadsheets')) {
                showMessage('URL harus berupa link Google Sheets yang valid!', 'error');
                return;
            }

            // Convert sharing URL to CSV export URL if needed
            let csvUrl = url;
            if (url.includes('/edit#gid=') || url.includes('/edit?usp=')) {
                const spreadsheetId = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                const gidMatch = url.match(/[#&]gid=([0-9]+)/);
                const gid = gidMatch ? gidMatch[1] : '0';
                
                if (spreadsheetId) {
                    csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId[1]}/export?format=csv&gid=${gid}`;
                }
            }

            sheetsUrl = csvUrl;
            loadDataFromSheets();
        }

        // Default Google Sheets URL - GANTI DENGAN URL SHEETS ANDA
        const DEFAULT_SHEETS_URL = '';
        // Contoh: 'https://docs.google.com/spreadsheets/d/1ABC123.../export?format=csv&gid=0'

        async function loadDataFromSheets() {
            showLoading();
            updateConnectionStatus('connecting');
            
            try {
                // Multiple CORS proxy options - akan mencoba satu per satu
                const proxyOptions = [
                    'https://api.allorigins.win/raw?url=',
                    'https://cors.io/?',
                    'https://thingproxy.freeboard.io/fetch/',
                    'https://cors-anywhere.herokuapp.com/'
                ];
                
                let response;
                let lastError;
                
                // Coba setiap proxy sampai berhasil
                for (const proxyUrl of proxyOptions) {
                    try {
                        const url = proxyUrl.includes('allorigins') ? 
                            proxyUrl + encodeURIComponent(sheetsUrl) : 
                            proxyUrl + sheetsUrl;
                        
                        response = await fetch(url);
                        
                        if (response.ok) {
                            break; // Berhasil, keluar dari loop
                        }
                    } catch (error) {
                        lastError = error;
                        continue; // Coba proxy berikutnya
                    }
                }
                
                if (!response || !response.ok) {
                    throw lastError || new Error(`HTTP error! status: ${response?.status || 'Network Error'}`);
                }
                
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                if (parsedData.length === 0) {
                    throw new Error('Tidak ada data ditemukan atau format CSV tidak valid');
                }

                allData = parsedData;
                filteredData = [...allData];
                
                updateConnectionStatus('connected');
                enableControls();
                updatePagination();
                displayCurrentPage();
                
                showMessage(`Berhasil terhubung! ${allData.length} record dimuat.`, 'success');
                hideConfigSection();
                
            } catch (error) {
                updateConnectionStatus('error');
                showMessage(`Gagal terhubung: ${error.message}. 

Solusi yang bisa dicoba:
1. Pastikan Google Sheets sudah di-publish ke web dalam format CSV
2. Pastikan sheet dapat diakses publik  
3. Coba refresh halaman (beberapa CORS proxy memiliki limit)
4. Jika masih error, coba ganti URL proxy di kode

Tips: Akses https://cors-anywhere.herokuapp.com/corsdemo untuk aktivasi CORS proxy`, 'error');
                console.error('Error loading data:', error);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = parseCSVLine(line);
                
                if (columns.length >= 9) {
                    data.push({
                        deskripsi: columns[0] || '',
                        tanggal: columns[1] || '',
                        noSumber: columns[2] || '',
                        tipe: columns[3] || '',
                        kodeProd: columns[4] || '',
                        keterangan: columns[5] || '',
                        ktsMasuk: columns[6] || '0',
                        ktsKeluar: columns[7] || '0',
                        saldoAkhir: columns[8] || '0'
                    });
                }
            }
            
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(col => col.replace(/^"|"$/g, ''));
        }

        // Search and filter functions
        function searchData() {
            const searchTerm = document.getElementById('searchItem').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            showLoading();

            setTimeout(() => {
                filteredData = allData.filter(item => {
                    // Filter by description
                    const matchesDescription = !searchTerm || 
                        item.deskripsi.toLowerCase().includes(searchTerm);

                    // Filter by date range
                    let matchesDate = true;
                    if (dateFrom || dateTo) {
                        const itemDate = new Date(item.tanggal);
                        if (dateFrom && itemDate < new Date(dateFrom)) matchesDate = false;
                        if (dateTo && itemDate > new Date(dateTo)) matchesDate = false;
                    }

                    return matchesDescription && matchesDate;
                });

                currentPage = 1;
                updatePagination();
                displayCurrentPage(searchTerm);
            }, 300);
        }

        function clearFilters() {
            document.getElementById('searchItem').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            filteredData = [...allData];
            currentPage = 1;
            updatePagination();
            displayCurrentPage();
        }

        // Pagination functions
        function updatePagination() {
            totalPages = Math.ceil(filteredData.length / pageSize);
            
            document.getElementById('resultsCount').textContent = 
                `Menampilkan ${filteredData.length} dari ${allData.length} total data`;
                
            document.getElementById('paginationInfo').textContent = 
                `Halaman ${currentPage} dari ${totalPages}`;
            
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function displayCurrentPage(highlightTerm = '') {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('tableBody');
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">🔍</div>
                        <div>Tidak ada data yang sesuai dengan kriteria pencarian</div>
                    </div>
                `;
                return;
            }

            tbody.innerHTML = pageData.map(item => {
                let deskripsi = item.deskripsi;
                if (highlightTerm) {
                    const regex = new RegExp(`(${highlightTerm})`, 'gi');
                    deskripsi = deskripsi.replace(regex, '<span class="highlight">$1</span>');
                }

                return `
                    <div class="table-row">
                        <div class="table-cell">${deskripsi}</div>
                        <div class="table-cell date-cell">${formatDate(item.tanggal)}</div>
                        <div class="table-cell">${item.noSumber}</div>
                        <div class="table-cell">
                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; ${getTypeStyle(item.tipe)}">
                                ${item.tipe}
                            </span>
                        </div>
                        <div class="table-cell">
                            <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${item.kodeProd}</code>
                        </div>
                        <div class="table-cell">${item.keterangan}</div>
                        <div class="table-cell number-cell">${formatNumber(item.ktsMasuk)}</div>
                        <div class="table-cell number-cell">${formatNumber(item.ktsKeluar)}</div>
                        <div class="table-cell number-cell"><strong>${formatNumber(item.saldoAkhir)}</strong></div>
                    </div>
                `;
            }).join('');
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updatePagination();
                displayCurrentPage();
                scrollToTop();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                updatePagination();
                displayCurrentPage();
                scrollToTop();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            updatePagination();
            displayCurrentPage();
        }

        function scrollToTop() {
            document.getElementById('tableContainer').scrollTop = 0;
        }

        // Utility functions
        function getTypeStyle(type) {
            const styles = {
                'masuk': 'background-color: #d4edda; color: #155724;',
                'keluar': 'background-color: #f8d7da; color: #721c24;',
                'default': 'background-color: #e2e3e5; color: #383d41;'
            };
            return styles[type.toLowerCase()] || styles.default;
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return dateString;
            }
        }

        function formatNumber(value) {
            if (!value || value === '0') return '-';
            return parseFloat(value).toLocaleString('id-ID');
        }

        function showLoading() {
            document.getElementById('tableBody').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Sedang memuat data...
                </div>
            `;
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            let className = 'info-message';
            
            switch(type) {
                case 'error':
                    className = 'error-message';
                    break;
                case 'success':
                    className = 'success-message';
                    break;
                default:
                    className = 'info-message';
            }
            
            container.innerHTML = `
                <div class="${className}">
                    ${message}
                </div>
            `;
            
            // Auto-hide setelah 10 detik untuk pesan info
            if (type === 'info') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 10000);
            } else {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 8000);
            }
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'connected':
                    statusEl.className = 'status-indicator status-connected';
                    statusEl.innerHTML = '<span>●</span> Terhubung';
                    isConnected = true;
                    break;
                case 'connecting':
                    statusEl.className = 'status-indicator';
                    statusEl.innerHTML = '<span>●</span> Menghubungkan...';
                    statusEl.style.color = '#f39c12';
                    break;
                case 'error':
                default:
                    statusEl.className = 'status-indicator status-disconnected';
                    statusEl.innerHTML = '<span>●</span> Tidak Terhubung';
                    isConnected = false;
            }
        }

        function enableControls() {
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('clearBtn').disabled = false;
        }

        function hideConfigSection() {
            document.getElementById('configSection').style.display = 'none';
        }

        // Event listeners
        document.getElementById('searchItem').addEventListener('input', debounce(searchData, 500));
        document.getElementById('dateFrom').addEventListener('change', searchData);
        document.getElementById('dateTo').addEventListener('change', searchData);
        document.getElementById('searchItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        // Keyboard shortcuts for pagination
        document.addEventListener('keydown', function(e) {
            if (!isConnected) return;
            
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        previousPage();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        nextPage();
                        break;
                }
            }
        });

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            if (isConnected && sheetsUrl) {
                console.log('Auto-refreshing data...');
                loadDataFromSheets();
            }
        }, 5 * 60 * 1000);

        // Initialize with default URL or URL params
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sheetsParam = urlParams.get('sheets');
            
            if (sheetsParam) {
                // Load dari URL parameter
                document.getElementById('sheetsUrl').value = decodeURIComponent(sheetsParam);
                connectToSheets();
            } else if (DEFAULT_SHEETS_URL) {
                // Load dari default URL yang sudah di-set
                document.getElementById('sheetsUrl').value = DEFAULT_SHEETS_URL;
                showMessage('Menggunakan URL Google Sheets default. Klik "Hubungkan ke Google Sheets" untuk memuat data.', 'info');
            }
            
            // Tampilkan instruksi jika belum ada URL
            if (!DEFAULT_SHEETS_URL && !sheetsParam) {
                showMessage(`
                    <strong>Selamat datang!</strong><br>
                    Untuk memulai, masukkan URL Google Sheets Anda di field di atas.<br>
                    Atau, developer dapat mengatur DEFAULT_SHEETS_URL di kode.
                `, 'info');
            }
        });
